<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDA Data Processor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(to bottom right, #4f46e5, #7c3aed);
            min-height: 100vh;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            margin-bottom: 10px;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            margin: 20px 0;
        }
        .upload-zone:hover {
            background: #f3f4f6;
            border-color: #4f46e5;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #4338ca;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .success-btn {
            background: #10b981;
        }
        .success-btn:hover {
            background: #059669;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11px;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 6px;
            text-align: center;
        }
        th {
            background: #f3f4f6;
            font-weight: 600;
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }
        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }
        .progress {
            width: 100%;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            height: 100%;
            background: #4f46e5;
            text-align: center;
            color: white;
            line-height: 24px;
            transition: width 0.3s;
        }
        .note {
            background: #fef3c7;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>EDA Data Processor</h1>
        <p>Process your 152 EDA files into the master sheet format</p>
        
        <div class="upload-zone" onclick="document.getElementById('files').click()">
            <p style="font-size: 48px; margin: 0;">üìÅ</p>
            <p><strong>Click to select your 152 files</strong></p>
            <p style="font-size: 14px; color: #6b7280;">CSV or TXT files with Period-wise data</p>
            <p id="fileInfo" style="color: #10b981; font-weight: bold;"></p>
        </div>
        <input type="file" id="files" multiple accept=".csv,.txt" style="display: none;">
        
        <div class="note">
            <strong>üìã Input File Format Expected:</strong><br>
            Columns: Period, Duration, Mean SCR, SCR Frequency, Total SCRs, SCL Slope, NS-SCL, Mean Std Dev (I%S)<br>
            Rows should contain: Baseline, Instruction, REINSTATEMENT, PGQ, Overall
        </div>
        
        <button id="processBtn" disabled onclick="processAllFiles()">‚öôÔ∏è Process All Files</button>
        <button id="downloadBtn" class="success-btn" style="display: none;" onclick="downloadCSV()">‚¨áÔ∏è Download Master Sheet</button>
        
        <div id="status"></div>
        <div id="progress"></div>
        <div id="results"></div>
    </div>

    <script>
        let files = [];
        let results = [];
        
        document.getElementById('files').addEventListener('change', function(e) {
            files = Array.from(e.target.files);
            document.getElementById('fileInfo').textContent = files.length + ' files selected';
            document.getElementById('processBtn').disabled = files.length === 0;
        });
        
        async function processAllFiles() {
            document.getElementById('processBtn').disabled = true;
            document.getElementById('downloadBtn').style.display = 'none';
            results = [];
            
            document.getElementById('status').innerHTML = '<div class="alert alert-info">Processing files...</div>';
            
            for (let i = 0; i < files.length; i++) {
                updateProgress(i + 1, files.length);
                const data = await parseCSV(files[i]);
                const metrics = extractMetrics(files[i].name, data);
                results.push(metrics);
            }
            
            document.getElementById('progress').innerHTML = '';
            document.getElementById('status').innerHTML = '<div class="alert alert-success">‚úÖ Processing complete! ' + results.length + ' files processed.</div>';
            showResults();
            document.getElementById('downloadBtn').style.display = 'inline-block';
            document.getElementById('processBtn').disabled = false;
        }
        
        function parseCSV(file) {
            return new Promise((resolve) => {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: (r) => resolve(r.data)
                });
            });
        }
        
        function updateProgress(current, total) {
            const pct = Math.round((current / total) * 100);
            document.getElementById('progress').innerHTML = 
                '<div class="progress"><div class="progress-bar" style="width:' + pct + '%">' + pct + '% (' + current + '/' + total + ')</div></div>';
        }
        
        function extractMetrics(filename, data) {
            const id = filename.replace(/\.(csv|txt)$/i, '').replace(/_period_analysis_summary$/i, '');
            
            // Find the rows for each period
            const baseline = data.find(row => {
                const period = String(row.Period || '').toLowerCase();
                return period.includes('baseline');
            });
            
            const reinstatement = data.find(row => {
                const period = String(row.Period || '').toLowerCase();
                return period.includes('reinst') || period.includes('instruction');
            });
            
            const pgq = data.find(row => {
                const period = String(row.Period || '').toLowerCase();
                return period.includes('pgq');
            });
            
            // Extract values with proper column name detection
            const getValues = (row) => {
                if (!row) return {
                    meanSCL: 'N/A',
                    meanSCR: 'N/A',
                    scrFreq: 'N/A',
                    totalSCRs: 'N/A',
                    sclSlope: 'N/A',
                    nsSCL: 'N/A',
                    sclStdDev: 'N/A',
                    scrStdDev: 'N/A'
                };
                
                // Find column names (case-insensitive and flexible matching)
                const keys = Object.keys(row);
                const meanSCRKey = keys.find(k => k.toLowerCase().includes('mean scr'));
                const scrFreqKey = keys.find(k => k.toLowerCase().includes('scr freq'));
                const totalSCRKey = keys.find(k => k.toLowerCase().includes('total scr'));
                const sclSlopeKey = keys.find(k => k.toLowerCase().includes('scl slope'));
                const nsSCLKey = keys.find(k => k.toLowerCase().includes('ns-scl') || k.toLowerCase().includes('ns scl'));
                const stdDevKey = keys.find(k => k.toLowerCase().includes('std dev') || k.toLowerCase().includes('mean std'));
                
                return {
                    meanSCL: row['Mean SCL'] || row['Mean SCL (%S)'] || 'N/A',
                    meanSCR: row[meanSCRKey] || row['Mean SCR'] || 'N/A',
                    scrFreq: row[scrFreqKey] || row['SCR Frequency'] || 'N/A',
                    totalSCRs: row[totalSCRKey] || row['Total SCRs'] || 'N/A',
                    sclSlope: row[sclSlopeKey] || row['SCL Slope'] || 'N/A',
                    nsSCL: row[nsSCLKey] || row['NS-SCL'] || 'N/A',
                    sclStdDev: row[stdDevKey] || row['Mean Std Dev (%S)'] || 'N/A',
                    scrStdDev: row[stdDevKey] || row['Mean Std Dev (%S)'] || 'N/A'
                };
            };
            
            const baselineVals = getValues(baseline);
            const reinstVals = getValues(reinstatement);
            const pgqVals = getValues(pgq);
            
            return {
                id: id,
                name: id,
                baseline: baselineVals,
                reinstatement: reinstVals,
                pgq: pgqVals
            };
        }
        
        function showResults() {
            let html = '<h2>üìä Master Sheet Preview (' + results.length + ' participants)</h2>';
            html += '<p style="font-size: 12px; color: #666;">Showing first 10 rows - Download CSV for complete data</p>';
            html += '<div style="overflow-x: auto;"><table>';
            
            // Header row 1 - Metric names
            html += '<thead><tr>';
            html += '<th rowspan="2">id</th><th rowspan="2">NAME</th>';
            html += '<th colspan="3">Mean SCL (%S)</th>';
            html += '<th colspan="3">Mean SCR (%S)</th>';
            html += '<th colspan="3">SCR Frequency (per min)</th>';
            html += '<th colspan="3">Total SCRs</th>';
            html += '<th colspan="3">SCL Slope (%S/s)</th>';
            html += '<th colspan="3">NS-SCL (%S)</th>';
            html += '<th colspan="3">SCL Std Dev (%S)</th>';
            html += '<th colspan="3">SCR Std Dev (%S)</th>';
            html += '</tr>';
            
            // Header row 2 - Phase names
            html += '<tr>';
            for (let i = 0; i < 8; i++) {
                html += '<th>BASELINE</th><th>REINSTATEMENT</th><th>PGQ</th>';
            }
            html += '</tr></thead><tbody>';
            
            // Data rows
            results.slice(0, 10).forEach(r => {
                html += '<tr>';
                html += '<td>' + r.id + '</td>';
                html += '<td>' + r.name + '</td>';
                
                // Mean SCL
                html += '<td>' + r.baseline.meanSCL + '</td>';
                html += '<td>' + r.reinstatement.meanSCL + '</td>';
                html += '<td>' + r.pgq.meanSCL + '</td>';
                
                // Mean SCR
                html += '<td>' + r.baseline.meanSCR + '</td>';
                html += '<td>' + r.reinstatement.meanSCR + '</td>';
                html += '<td>' + r.pgq.meanSCR + '</td>';
                
                // SCR Frequency
                html += '<td>' + r.baseline.scrFreq + '</td>';
                html += '<td>' + r.reinstatement.scrFreq + '</td>';
                html += '<td>' + r.pgq.scrFreq + '</td>';
                
                // Total SCRs
                html += '<td>' + r.baseline.totalSCRs + '</td>';
                html += '<td>' + r.reinstatement.totalSCRs + '</td>';
                html += '<td>' + r.pgq.totalSCRs + '</td>';
                
                // SCL Slope
                html += '<td>' + r.baseline.sclSlope + '</td>';
                html += '<td>' + r.reinstatement.sclSlope + '</td>';
                html += '<td>' + r.pgq.sclSlope + '</td>';
                
                // NS-SCL
                html += '<td>' + r.baseline.nsSCL + '</td>';
                html += '<td>' + r.reinstatement.nsSCL + '</td>';
                html += '<td>' + r.pgq.nsSCL + '</td>';
                
                // SCL Std Dev
                html += '<td>' + r.baseline.sclStdDev + '</td>';
                html += '<td>' + r.reinstatement.sclStdDev + '</td>';
                html += '<td>' + r.pgq.sclStdDev + '</td>';
                
                // SCR Std Dev
                html += '<td>' + r.baseline.scrStdDev + '</td>';
                html += '<td>' + r.reinstatement.scrStdDev + '</td>';
                html += '<td>' + r.pgq.scrStdDev + '</td>';
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        function downloadCSV() {
            // Create headers exactly as shown in your template
            const headers = [
                'id', 'NAME',
                'Mean SCL (%S) BASELINE', 'Mean SCL (%S) REINSTATEMENT', 'Mean SCL (%S) PGQ',
                'Mean SCR (%S) BASELINE', 'Mean SCR (%S) REINSTATEMENT', 'Mean SCR (%S) PGQ',
                'SCR Frequency (per min) BASELINE', 'SCR Frequency (per min) REINSTATEMENT', 'SCR Frequency (per min) PGQ',
                'Total SCRs BASELINE', 'Total SCRs REINSTATEMENT', 'Total SCRs PGQ',
                'SCL Slope (%S/s) BASELINE', 'SCL Slope (%S/s) REINSTATEMENT', 'SCL Slope (%S/s) PGQ',
                'NS-SCL (%S) BASELINE', 'NS-SCL (%S) REINSTATEMENT', 'NS-SCL (%S) PGQ',
                'SCL Std Dev (%S) BASELINE', 'SCL Std Dev (%S) REINSTATEMENT', 'SCL Std Dev (%S) PGQ',
                'SCR Std Dev (%S) BASELINE', 'SCR Std Dev (%S) REINSTATEMENT', 'SCR Std Dev (%S) PGQ'
            ];
            
            const rows = results.map(r => [
                r.id,
                r.name,
                r.baseline.meanSCL, r.reinstatement.meanSCL, r.pgq.meanSCL,
                r.baseline.meanSCR, r.reinstatement.meanSCR, r.pgq.meanSCR,
                r.baseline.scrFreq, r.reinstatement.scrFreq, r.pgq.scrFreq,
                r.baseline.totalSCRs, r.reinstatement.totalSCRs, r.pgq.totalSCRs,
                r.baseline.sclSlope, r.reinstatement.sclSlope, r.pgq.sclSlope,
                r.baseline.nsSCL, r.reinstatement.nsSCL, r.pgq.nsSCL,
                r.baseline.sclStdDev, r.reinstatement.sclStdDev, r.pgq.sclStdDev,
                r.baseline.scrStdDev, r.reinstatement.scrStdDev, r.pgq.scrStdDev
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'EDA_MASTERSHEET.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('status').innerHTML = '<div class="alert alert-success">‚úÖ File downloaded: EDA_MASTERSHEET.csv</div>';
        }
    </script>
</body>
</html>
