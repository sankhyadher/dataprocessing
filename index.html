<script>
let files = [];
let results = [];

document.getElementById("files").addEventListener("change", e => {
    files = Array.from(e.target.files);
    document.getElementById("fileInfo").textContent = files.length + " files selected";
    document.getElementById("processBtn").disabled = files.length === 0;
});


async function processAllFiles() {
    results = [];
    document.getElementById("downloadBtn").style.display = "none";

    for (let i = 0; i < files.length; i++) {
        updateProgress(i + 1, files.length);

        const data = await parseCSV(files[i]);
        const metrics = extractMetrics(files[i].name, data);
        results.push(metrics);
    }

    showResults();
    document.getElementById("downloadBtn").style.display = "inline-block";
}


function updateProgress(count, total) {
    const pct = Math.round((count / total) * 100);
    document.getElementById("progress").innerHTML =
        `<div class="progress"><div class="progress-bar" style="width:${pct}%">${pct}%</div></div>`;
}


// ------- CSV PARSER -------
function parseCSV(file) {
    return new Promise(resolve => {
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: r => resolve(r.data)
        });
    });
}


// ----------- MAIN EXTRACTION LOGIC -----------
function extractMetrics(filename, data) {

    const id = filename.replace(/\.(csv|txt)$/i, "").replace("_period_analysis_summary", "");
    const name = id;

    // FIXED ROW POSITIONS
    const baseline      = data[0]; // row 2
    const reinstatement = data[2]; // row 4
    const pgq           = data[3]; // row 5

    // Helper: extract a specific metric safely
    function metric(row, key) {
        if (!row) return "N/A";
        const col = Object.keys(row).find(k => k.toLowerCase().includes(key.toLowerCase()));
        return row[col] ?? "N/A";
    }

    // Build output row object
    return {
        id,
        name,

        baseline: {
            meanSCL: metric(baseline, "mean scl"),
            meanSCR: metric(baseline, "mean scr"),
            scrFreq: metric(baseline, "scr freq"),
            totalSCR: metric(baseline, "total scr"),
            sclSlope: metric(baseline, "scl slope"),
            nsSCL: metric(baseline, "ns-scl"),
            sclStd: metric(baseline, "scl std"),
            scrStd: metric(baseline, "scr std")
        },

        reinstatement: {
            meanSCL: metric(reinstatement, "mean scl"),
            meanSCR: metric(reinstatement, "mean scr"),
            scrFreq: metric(reinstatement, "scr freq"),
            totalSCR: metric(reinstatement, "total scr"),
            sclSlope: metric(reinstatement, "scl slope"),
            nsSCL: metric(reinstatement, "ns-scl"),
            sclStd: metric(reinstatement, "scl std"),
            scrStd: metric(reinstatement, "scr std")
        },

        pgq: {
            meanSCL: metric(pgq, "mean scl"),
            meanSCR: metric(pgq, "mean scr"),
            scrFreq: metric(pgq, "scr freq"),
            totalSCR: metric(pgq, "total scr"),
            sclSlope: metric(pgq, "scl slope"),
            nsSCL: metric(pgq, "ns-scl"),
            sclStd: metric(pgq, "scl std"),
            scrStd: metric(pgq, "scr std")
        }
    };
}


// --------- PREVIEW TABLE ---------
function showResults() {
    let html = `
    <h3>Preview (first 10 rows)</h3>
    <table>
        <thead>
            <tr>
                <th>ID</th><th>NAME</th>
                <th>Mean SCL BASELINE</th><th>Mean SCL REINST</th><th>Mean SCL PGQ</th>
                <th>Mean SCR BASELINE</th><th>Mean SCR REINST</th><th>Mean SCR PGQ</th>
                <th>SCR Freq BASELINE</th><th>SCR Freq REINST</th><th>SCR Freq PGQ</th>
                <th>Total SCR BASELINE</th><th>Total SCR REINST</th><th>Total SCR PGQ</th>
                <th>SCL Slope BASELINE</th><th>SCL Slope REINST</th><th>SCL Slope PGQ</th>
                <th>NS-SCL BASELINE</th><th>NS-SCL REINST</th><th>NS-SCL PGQ</th>
                <th>SCL Std BASELINE</th><th>SCL Std REINST</th><th>SCL Std PGQ</th>
                <th>SCR Std BASELINE</th><th>SCR Std REINST</th><th>SCR Std PGQ</th>
            </tr>
        </thead><tbody>
    `;

    results.slice(0, 10).forEach(r => {
        html += `
        <tr>
            <td>${r.id}</td><td>${r.name}</td>

            <td>${r.baseline.meanSCL}</td><td>${r.reinstatement.meanSCL}</td><td>${r.pgq.meanSCL}</td>
            <td>${r.baseline.meanSCR}</td><td>${r.reinstatement.meanSCR}</td><td>${r.pgq.meanSCR}</td>
            <td>${r.baseline.scrFreq}</td><td>${r.reinstatement.scrFreq}</td><td>${r.pgq.scrFreq}</td>
            <td>${r.baseline.totalSCR}</td><td>${r.reinstatement.totalSCR}</td><td>${r.pgq.totalSCR}</td>
            <td>${r.baseline.sclSlope}</td><td>${r.reinstatement.sclSlope}</td><td>${r.pgq.sclSlope}</td>
            <td>${r.baseline.nsSCL}</td><td>${r.reinstatement.nsSCL}</td><td>${r.pgq.nsSCL}</td>
            <td>${r.baseline.sclStd}</td><td>${r.reinstatement.sclStd}</td><td>${r.pgq.sclStd}</td>
            <td>${r.baseline.scrStd}</td><td>${r.reinstatement.scrStd}</td><td>${r.pgq.scrStd}</td>
        </tr>`;
    });

    html += "</tbody></table>";
    document.getElementById("results").innerHTML = html;
}


// ---------- CSV EXPORT ----------
function downloadCSV() {

    const header = [
        "id","NAME",
        "Mean SCL BASELINE","Mean SCL REINST","Mean SCL PGQ",
        "Mean SCR BASELINE","Mean SCR REINST","Mean SCR PGQ",
        "SCR Freq BASELINE","SCR Freq REINST","SCR Freq PGQ",
        "Total SCR BASELINE","Total SCR REINST","Total SCR PGQ",
        "SCL Slope BASELINE","SCL Slope REINST","SCL Slope PGQ",
        "NS-SCL BASELINE","NS-SCL REINST","NS-SCL PGQ",
        "SCL Std BASELINE","SCL Std REINST","SCL Std PGQ",
        "SCR Std BASELINE","SCR Std REINST","SCR Std PGQ"
    ];

    const rows = results.map(r => [
        r.id, r.name,
        r.baseline.meanSCL, r.reinstatement.meanSCL, r.pgq.meanSCL,
        r.baseline.meanSCR, r.reinstatement.meanSCR, r.pgq.meanSCR,
        r.baseline.scrFreq, r.reinstatement.scrFreq, r.pgq.scrFreq,
        r.baseline.totalSCR, r.reinstatement.totalSCR, r.pgq.totalSCR,
        r.baseline.sclSlope, r.reinstatement.sclSlope, r.pgq.sclSlope,
        r.baseline.nsSCL, r.reinstatement.nsSCL, r.pgq.nsSCL,
        r.baseline.sclStd, r.reinstatement.sclStd, r.pgq.sclStd,
        r.baseline.scrStd, r.reinstatement.scrStd, r.pgq.scrStd
    ]);

    const csv = [header, ...rows].map(r => r.join(",")).join("\n");

    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
    link.download = "EDA_MASTER_SHEET.csv";
    link.click();
}
</script>
